<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Quizapp refactored to ReactJS</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
		<script src="https://cdn.firebase.com/js/client/2.3.0/firebase.js"></script>

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">
	</head>
	<body>
		<div id="content"></div>
  <script type="text/jsx">

	var QuestionsBox = React.createClass({
		getInitialState: function() {
			return {
				currentQuestion: 0,
				answerSelections: [],
				timeLeft: this.props.timePerQuestion,
				score: 0,
				quizActive: true,
				results: []
			}
		},
		getDefaultProps: function () {
    	return {
				timePerQuestion: 3
			};
  	},
		choiceMade: function(id) {
			var answers = this.state.answerSelections.slice();
			answers.push(id);
			var choiceResults = this.state.results.slice();


			if (quiz[this.state.currentQuestion].answer == id) { //correct
				var updatedScore = this.calcScore(this.state.timeLeft);
				choiceResults.push(true);
			}
			else {//incorrect choice
				updatedScore = this.state.score;
				choiceResults.push(false);
			}


			if ((quiz.length - 1) <= this.state.currentQuestion) {
				clearInterval(this.timer);
				quizActive = false;
			}
			else {
				quizActive = true;
			}

			var newState = {
				currentQuestion: this.state.currentQuestion + 1,
				answerSelections: answers,
				timeLeft: this.props.timePerQuestion,
				score: updatedScore,
				quizActive: quizActive,
				results: choiceResults
			};
			this.setState(newState);

		},
		calcScore: function(timeLeft) {
			var newScore = this.state.score + 10;
			if (this.state.timeLeft > 5) {
				newScore += 2;
			}
			return newScore;
		},
		tick: function() {
			var newTimerState = {
				currentQuestion: this.state.currentQuestion,
				answerSelections: this.state.answerSelections,
				timeLeft: this.state.timeLeft - 1,
				score: this.state.score,
				quizActive: true,
				results: this.state.results
			}
			this.setState(newTimerState);
		},
		componentDidMount: function() {
			var myFirebaseRef = new Firebase("https://dazzling-inferno-26.firebaseio.com/");
			myFirebaseRef.push({
				game: this.state
			});
			this.timer = setInterval(this.tick, 1000);
		},
		componentDidUpdate: function() {
			if (this.state.timeLeft < 0) { //check if time expired
				this.choiceMade(false);
			}
		},
		render: function() {
			var question = this.props.quiz[this.state.currentQuestion];
			return (
				<div className="questionsbox">
					{this.state.quizActive &&
						<div>
							<QuestionPrompt question={question.prompt} />
							<Choices choices={question.choices} onClick={this.choiceMade} />
							<Timer timeLeft={this.state.timeLeft} />
							<Score score={this.state.score} />
							<QuestionImage currentQuestion={this.state.currentQuestion} />
						</div>
						|| <FinalScore score={this.state.score} />
				  }
					<ScoreBoard results={this.state.results} />
				</div>
			);
		}
	});
	var ScoreBoard = React.createClass({
		render: function() {
				var answerResults = this.props.results.map(function(result, i) {
					return (
						<li key={i}>{result ? "Correct" : "Incorrect"}</li>
					);
				});

				return (
					<div>
						<h2>Scoreboard Results</h2>
						<ol>
							{answerResults}
						</ol>
					</div>
				);
		}
	});

	var FinalScore = React.createClass({
		render: function() {
			return (
				<h1>FINAL Score: {this.props.score}</h1>
			);
		}
	});

	var Score = React.createClass({
		render: function () {
			return (
				<h1>Current Score: {this.props.score}</h1>
			);
		}
	});

	var Timer = React.createClass({
		render: function() {
			return (
				<h2>Time Left: {this.props.timeLeft}</h2>
			);
		}
	});

	var QuestionImage = React.createClass({
		render: function() {
			var imageStyle = {
				width: '30%',
				float: 'right'
			};
			return (
				<img style={imageStyle} src={"img/" + (this.props.currentQuestion + 1) + ".jpg"}></img>
			);
		}
	});

	var QuestionPrompt = React.createClass({
		render: function() {
			return (
				<h1>{this.props.question}</h1>
			);
		}
	});

	var Choices = React.createClass({
		render: function() {
			var clickHandler = this.props.onClick;
			var styles = {
				height: '100px',
				width: '300px',
				fontSize: '160%',
				fontWeight: '500',
				margin: '0 auto'
			}

			var choices = this.props.choices.map(function(choice, i) {
				return (
					<div key={i}><button style={styles} className='button-xlarge pure-button' onClick={clickHandler.bind(null, i)}>{choice}</button></div>
				);
			});

			// es6:
			// var choices = this.props.choices.map((choice, i) => <li key={i}>{choice}</li>);

			return (
				<div>
					{choices}
				</div>
			);
		}
	});

var quiz = [
	{
		prompt: "What is Bran unable to do due to his injuries?",
		choices: ["Sleep","Archery","Walk","Eat"],
		answer: 2
	},
	{
		prompt: "Where is Theon Greyjoy tasked with raiding using only one ship by his father?",
		choices: ["Villages along the Stony Shore","Coastal towns of Bear Island","Ports along Blazewater Bay","Cape Kraken"],
		answer: 0
	},
	{
		prompt: "As Maester Luwin is dying, he tells Osha to take Rickon and Bran Stark to",
		choices: ["Riverrun to find their mother","the Wall to find their brother Jon","Rivverun to find Rob", "King's Landing to find Arya and Sansa","find Benjen Stark north of the Wall"],
		answer: 1
	},
	{
		prompt: "What does Arya earn after she helped the Hound in the fight with Polliver's men?",
		choices: ["Horse","Armor","Chicken","Freedom"],
		answer: 0
	},
	{
		prompt: "Who does Robb Stark send to make an alliance with Balon Greyjoy?",
		choices: ["Catelyn","Bran","Lord Umber","Theon"],
		answer: 3
	},
	{
		prompt: "Which city is Ser Loras Tyrell the heir to?",
		choices: ["Riverrun","King's Landing","Highgarden","Winterfell"],
		answer: 2
	},
	{
		prompt: "Who does Sansa beg to light a candle for her in Winterfell?",
		choices: ["Theon","Podrick","Brienne","Roose"],
		answer: 0
	},
	{
		prompt: "What is the number of Lord Commanders that have served when Jon is elected?",
		choices: ["292","731","31","997"],
		answer: 3
	},
	{
		prompt: "What does Bronn save Jaime from being killed by?",
		choices: ["Jaguar","Boar","Rats","Snake"],
		answer: 3
	},
	{
		prompt: "Who says the name of the episode in 'The Wars To Come'?",
		choices: ["Mance","Daenerys","Tyrion","Sam"],
		answer: 0
	}
];

React.render(
	<QuestionsBox quiz={quiz} />,
	document.getElementById('content')
);

	</script>

	</body>
</html>
